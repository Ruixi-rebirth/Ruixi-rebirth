#!/usr/bin/env python3

import json
import os
import re
from datetime import datetime, timezone, timedelta
from urllib.request import Request, urlopen


def create_query():
    """å®šä¹‰ GitHub GraphQL æŸ¥è¯¢è¯­å¥ï¼Œè·å–ç»Ÿè®¡æ•°æ®å’Œé¡¹ç›®è¯¦æƒ…"""
    query = """
    {
      issues_all: search(type: ISSUE, query: "author:Ruixi-rebirth is:issue") {
        issueCount
      }
      issues_closed: search(type: ISSUE, query: "author:Ruixi-rebirth is:issue is:closed") {
        issueCount
      }
      prs_all: search(type: ISSUE, query: "author:Ruixi-rebirth is:pr") {
        issueCount
      }
      prs_merged: search(type: ISSUE, query: "author:Ruixi-rebirth is:pr is:merged") {
        issueCount
      }
      user(login: "Ruixi-rebirth") {
        followers { totalCount }
        following { totalCount }
        gists { totalCount }
        issues { totalCount }
        pullRequests { totalCount }
        repositories(first: 100, isFork: false) {
          totalCount
          nodes {
            name
            description
            url
            forkCount
            stargazerCount
            viewerPermission
            primaryLanguage {
              name
            }
            languages(first: 100) {
              edges {
                node { name }
                size
              }
            }
          }
        }
        repositoriesContributedTo(privacy: PUBLIC) {
          totalCount
        }
      }
    }"""
    return query


def fetch_commits_count():
    """é€šè¿‡ GitHub REST API æœç´¢æ¥å£è·å–æ€» Commit æ•°"""
    request = Request(
        "https://api.github.com/search/commits?q=author:Ruixi-rebirth&per_page=1",
        headers={"Accept": "application/vnd.github.cloak-preview"},
    )
    response = json.load(urlopen(request))
    return response["total_count"]


def fetch_github_data(query):
    """æ‰§è¡Œ GraphQL æŸ¥è¯¢å¹¶è¿”å›æ•°æ®"""
    request = Request(
        "https://api.github.com/graphql",
        json.dumps({"query": query}).encode("ascii"),
        {"Authorization": f"token {os.environ['TOKEN']}"},
    )
    response = json.load(urlopen(request))
    return response["data"]


def generate_bar(percentage, length=20):
    """æ ¹æ®ç™¾åˆ†æ¯”ç”Ÿæˆ Unicode è¿›åº¦æ¡"""
    filled = int(round(length * percentage / 100))
    return "â–ˆ" * filled + "â–‘" * (length - filled)


def compile_projects(data, featured_names):
    """æ„å»ºç²¾é€‰é¡¹ç›®å±•ç¤ºæ¿å—ï¼ˆå¸¦å¤šè¯­è¨€å¾½ç« ï¼‰"""
    nodes = data["user"]["repositories"]["nodes"]
    projects = [n for n in nodes if n["name"] in featured_names]
    projects.sort(key=lambda x: x["stargazerCount"], reverse=True)

    rows = []
    for p in projects:
        # è·å–é¡¹ç›®å æ¯”å‰ä¸‰çš„è¯­è¨€ï¼Œå¹¶æ˜ å°„è‡³ Shields.io å›¾æ ‡
        repo_langs = sorted(p["languages"]["edges"], key=lambda x: x["size"], reverse=True)[:3]
        badges = []
        for l in repo_langs:
            name = l["node"]["name"]
            # é»˜è®¤ä½¿ç”¨è¯­è¨€åç§°çš„å°å†™ä½œä¸ºå›¾æ ‡å (Simple Icons è§„èŒƒ)
            logo = name.lower()
            
            # ç‰¹æ®Šå¤„ç†ï¼šéƒ¨åˆ†è¯­è¨€åœ¨ GitHub çš„åç§°ä¸ Simple Icons é‡Œçš„ ID ä¸ä¸€è‡´
            # Nix åœ¨å›¾æ ‡åº“ä¸­ç§°ä¸º nixos
            if name == "Nix": logo = "nixos"
            # Shell åœ¨å›¾æ ‡åº“ä¸­ç§°ä¸º gnubash
            elif name == "Shell": logo = "gnubash"
            # SCSS åœ¨å›¾æ ‡åº“ä¸­é€šå¸¸å…³è”ä¸º sass
            elif name == "SCSS": logo = "sass"
            
            badges.append(f'<img src="https://img.shields.io/badge/-{name}-333?style=flat-square&logo={logo}&logoColor=white" alt="{name}">')
        
        lang_display = " ".join(badges)
        desc = p["description"] if p["description"] else "No description provided."
        
        rows.append(
            f"""
  <tr>
    <td width="35%">
      <a href="{p['url']}"><b>{p['name']}</b></a><br>
      {lang_display}
    </td>
    <td width="50%">{desc}</td>
    <td width="15%" align="right">
      <b>â­ {p['stargazerCount']}</b><br>
      <b>ğŸ´ {p['forkCount']}</b>
    </td>
  </tr>"""
        )

    return f"""
<table width="100%">
  <thead>
    <tr>
      <th align="left">ğŸš€ Project</th>
      <th align="left">ğŸ“ Description</th>
      <th align="right">ğŸ“Š Stats</th>
    </tr>
  </thead>
  <tbody>
    {"".join(rows)}
  </tbody>
</table>
"""


def compile_readme(data, commits_count):
    """æ„å»ºæ€»è§ˆç»Ÿè®¡æ•°æ®å’Œè¯­è¨€åˆ†å¸ƒæ¿å—"""
    user = data["user"]
    
    # æ±‡æ€»æ‰€æœ‰ Admin æƒé™ä»“åº“çš„ Star å’Œ Fork æ€»æ•°
    forks = sum(repo["forkCount"] for repo in user["repositories"]["nodes"] if repo["viewerPermission"] == "ADMIN")
    stars = sum(repo["stargazerCount"] for repo in user["repositories"]["nodes"] if repo["viewerPermission"] == "ADMIN")

    # æ±‡æ€»å…¨ä»“åº“è¯­è¨€ä½¿ç”¨å æ¯”
    langs = {}
    for repo in user["repositories"]["nodes"]:
        for lang in repo["languages"]["edges"]:
            name = lang["node"]["name"]
            size = lang["size"]
            langs[name] = langs.get(name, 0) + size
    total_size = sum(langs.values())

    # å‡†å¤‡å·¦ä¾§åŸºç¡€ç»Ÿè®¡åˆ—è¡¨
    stats_list = [
        ("ğŸš€ Repositories", f"<a href='https://github.com/Ruixi-rebirth?tab=repositories'>{user['repositories']['totalCount']}</a>"),
        ("ğŸ“œ Gists", f"<a href='https://gist.github.com/Ruixi-rebirth'>{user['gists']['totalCount']}</a>"),
        ("â­ Stargazers", f"{stars}"),
        ("ğŸ´ Forks", f"{forks}"),
        ("ğŸ¤ Contributed to", f"{user['repositoriesContributedTo']['totalCount']}"),
        ("ğŸ“ˆ Commits", f"{commits_count}"),
        ("ğŸ“‹ Issues", f"{data['issues_all']['issueCount']} ({data['issues_closed']['issueCount']} closed)"),
        ("ğŸ”€ Pull requests", f"{data['prs_all']['issueCount']} ({data['prs_merged']['issueCount']} merged)"),
        ("ğŸ‘¥ Followers", f"<a href='https://github.com/Ruixi-rebirth?tab=followers'>{user['followers']['totalCount']}</a>"),
        ("ğŸ‘¤ Following", f"<a href='https://github.com/Ruixi-rebirth?tab=following'>{user['following']['totalCount']}</a>"),
    ]
    
    stats_rows = "\n".join([f"<tr><td>{label}</td><td align='right'><b>{val}</b></td></tr>" for label, val in stats_list])
    stats_col = f"<table>{stats_rows}</table>"

    # å‡†å¤‡å³ä¾§ Top 10 è¯­è¨€åˆ†å¸ƒå›¾
    langs_rows = []
    sorted_langs = sorted(langs.items(), key=lambda x: x[1], reverse=True)[:10]
    for lang, size in sorted_langs:
        percentage = round(size / total_size * 100, 2)
        bar = generate_bar(percentage, length=15)
        langs_rows.append(
            f"<tr><td>{lang}</td><td align='right'><code>{bar}</code> <b>{percentage}%</b></td></tr>"
        )
    langs_col = f"<table>{''.join(langs_rows)}</table>"

    return f"""
<table width="100%">
  <tr align="center">
    <th width="50%">ğŸ“Š Statistics</th>
    <th width="50%">ğŸ’» Languages</th>
  </tr>
  <tr valign="top">
    <td>{stats_col}</td>
    <td>{langs_col}</td>
  </tr>
</table>
"""


def main():
    """ä¸»ç¨‹åºï¼šè·å–æ•°æ®å¹¶ç²¾å‡†æ›´æ–° README.md çš„ç‰¹å®šåŒºåŸŸ"""
    query = create_query()
    commits_count = fetch_commits_count()
    data = fetch_github_data(query)
    
    # æ¸²æŸ“ç»Ÿè®¡å†…å®¹
    readme_stats = compile_readme(data, commits_count)

    # æ¸²æŸ“ç²¾é€‰é¡¹ç›®å†…å®¹ (å¯åœ¨æ­¤åˆ—è¡¨æ·»åŠ æ›´å¤šä»“åº“å)
    featured_projects = ["flakes"]
    projects_content = compile_projects(data, featured_projects)

    with open("README.md", "r") as f:
        content = f.read()

    # 1. æ›´æ–°ç»Ÿè®¡æ¿å— (STATS_START/END æ ‡è®°ä¹‹é—´)
    updated_content = re.sub(
        r"<!-- STATS_START -->.*?<!-- STATS_END -->", 
        f"<!-- STATS_START -->\n{readme_stats}\n<!-- STATS_END -->", 
        content, flags=re.DOTALL
    )

    # 2. æ›´æ–°ç²¾é€‰é¡¹ç›®æ¿å— (PROJECTS_START/END æ ‡è®°ä¹‹é—´)
    updated_content = re.sub(
        r"<!-- PROJECTS_START -->.*?<!-- PROJECTS_END -->", 
        f"<!-- PROJECTS_START -->\n{projects_content}\n<!-- PROJECTS_END -->", 
        updated_content, flags=re.DOTALL
    )

    # 3. æ›´æ–°æ—¶é—´æˆ³ (UTC+8 åŒ—äº¬æ—¶é—´)
    tz_utc_8 = timezone(timedelta(hours=8))
    last_updated_str = f"Last updated: {datetime.now(tz_utc_8).strftime('%F %T')} UTC+8"
    updated_content = re.sub(r"Last updated:.*", last_updated_str, updated_content)

    with open("README.md", "w") as file:
        file.write(updated_content)


if __name__ == "__main__":
    main()
